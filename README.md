# PHP_Laravel12_Get_Last_Executed_Query

A comprehensive Laravel 12 project demonstrating **multiple practical ways to retrieve the last executed SQL query** for debugging, learning, and performance analysis.

This repository is ideal for **students, developers, interview preparation, and real-world debugging scenarios**.

---

## Project Overview

Laravel provides several powerful tools to inspect SQL queries generated by Eloquent and the Query Builder. This project showcases **five commonly used and recommended approaches** with real examples and a clean UI dashboard.

You will learn:

* How Laravel internally executes SQL queries
* How to debug database queries safely
* When to use each debugging method

---

## Features

* Laravel 12 compatible
* 5 different query debugging techniques
* Interactive dashboard with examples
* Real-time query logging
* Middleware-based logging
* Clean, well-documented code
* Beginner-friendly structure

---

## Requirements

* PHP 8.1 or higher
* Laravel 12.x
* MySQL 5.7+ or MariaDB 10.3+
* Composer

---

## Installation Guide

### 1. Clone the Repository

```bash
git clone https://github.com/yourusername/laravel-query-debugger.git
cd laravel-query-debugger
```

### 2. Install Dependencies

```bash
composer install
```

### 3. Environment Setup

```bash
cp .env.example .env
php artisan key:generate
```

Update database configuration in `.env`:

```env
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=laravel_debug
DB_USERNAME=root
DB_PASSWORD=
```

### 4. Create Database and Run Migrations

```bash
mysql -u root -p -e "CREATE DATABASE IF NOT EXISTS laravel_debug;"
php artisan migrate
php artisan db:seed --class=ProductSeeder
```

### 5. Run the Application

```bash
php artisan serve
```

Open in browser:

```
http://localhost:8000/debug
```

---

## Debugging Methods Explained

### Method 1: DB::getQueryLog()

**Best for:** Debugging specific queries inside a controller or function.

```php
use Illuminate\Support\Facades\DB;

DB::enableQueryLog();
// Execute queries here
$queries = DB::getQueryLog();
$lastQuery = end($queries);
```

---

### Method 2: toSql() (Query Builder / Eloquent)

**Best for:** Viewing SQL before execution (no database hit).

```php
$query = Product::where('price', '>', 100);
$sql = $query->toSql();
```

Note: This does **not** include bound values.

---

### Method 3: DB::listen()

**Best for:** Global query monitoring.

```php
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

DB::listen(function ($query) {
    Log::info($query->sql, $query->bindings);
});
```

Logged queries can be found in:

```
storage/logs/laravel.log
```

---

### Method 4: Middleware-Based Query Logging

**Best for:** Environment-based or production-safe debugging.

* Logs queries only for specific routes
* Can be enabled/disabled by environment

Example use-case:

```php
if (app()->environment('local')) {
    DB::enableQueryLog();
}
```

---

### Method 5: Raw SQL Queries

**Best for:** Debugging `DB::select`, `insert`, `update`, and raw SQL.

```php
DB::enableQueryLog();
DB::select('SELECT * FROM products WHERE quantity > ?', [20]);
$queries = DB::getQueryLog();
```

---

## Project Structure

```
laravel-query-debugger/
├── app/
│   ├── Http/Controllers/QueryDebugController.php
│   ├── Http/Middleware/QueryLogMiddleware.php
│   └── Models/Product.php
├── resources/views/debug/
│   ├── dashboard.blade.php
│   ├── method1.blade.php
│   ├── method2.blade.php
│   ├── method3.blade.php
│   ├── method4.blade.php
│   └── method5.blade.php
├── database/
│   ├── migrations/
│   └── seeders/ProductSeeder.php
├── routes/web.php
└── README.md
```

---

## Performance Notes

* Query logging **affects performance**
* Enable logging only in **local or staging** environments
* Disable logs after debugging
* Avoid query logs in high-traffic production routes

---

## Troubleshooting

### MassAssignmentException

Ensure `$fillable` is defined in `Product.php`:

```php
protected $fillable = ['name', 'price', 'quantity'];
```

### Empty Query Log

* Call `DB::enableQueryLog()` **before executing queries**

### Middleware Not Logging

* Verify environment checks
* Ensure middleware is registered correctly

---

## Reset Application

```bash
php artisan migrate:fresh --seed
php artisan cache:clear
php artisan config:clear
php artisan view:clear
```

---

## Advanced Configuration

### Custom Query Log Channel

```php
'channels' => [
    'queries' => [
        'driver' => 'daily',
        'path' => storage_path('logs/queries.log'),
        'level' => 'info',
        'days' => 7,
    ],
],
```

### Environment-Based Logging

```php
if (app()->environment(['local', 'staging']) || config('app.debug')) {
    DB::enableQueryLog();
}
```

---

## Learning References

* Laravel Database Query Builder Documentation
* Laravel Eloquent ORM Documentation
* Laravel Debugbar Package

---

## Screenshots

<img width="1774" height="959" src="https://github.com/user-attachments/assets/03135f7e-5b7c-46c7-b8c8-7534ec19ab49" />
<img width="1758" height="887" src="https://github.com/user-attachments/assets/b8ac6f41-ff48-4ca1-8317-ee649ed9e039" />
<img width="1759" height="670" src="https://github.com/user-attachments/assets/0c98654a-f604-4af3-beea-c5eed900fdc3" />

---

## Conclusion

This project provides a **complete reference** for understanding and debugging SQL queries in Laravel 12. It is highly useful for:

* Learning Laravel internals
* Debugging slow or incorrect queries
* Interview preparation
* Real-world application development
